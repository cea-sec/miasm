sudo: required
language: python
python: 2.7
matrix:
    include:
    - os: osx
      language: generic
      install:
        - brew upgrade
        - brew install gcc tcc llvm
        - echo /usr/local/opt/llvm/lib/python2.7/site-packages >> /usr/local/lib/python2.7/site-packages/llvm.pth
        - pip install -vvv -r optional_requirements.txt
        - pip install -vvv -r requirements.txt
      env: PATH=/usr/local/opt/llvm/bin:$PATH LLVM_CONFIG=llvm-config LDFLAGS=-L/usr/local/opt/llvm/lib CPPFLAGS=-I/usr/local/opt/llvm/include
    - before_install: pip install -r optional_requirements.txt
    allow_failures:
    - os: osx
env: LLVM_CONFIG=llvm-config-4.0 CXX=g++-6
install:
    - curl -sSL "http://apt.llvm.org/llvm-snapshot.gpg.key" | sudo -E apt-key add -
    - echo "deb http://apt.llvm.org/precise/ llvm-toolchain-precise-4.0 main" | sudo tee -a /etc/apt/sources.list > /dev/null
    - sudo -E apt-add-repository -y "ppa:ubuntu-toolchain-r/test"
    - sudo apt-get update
    - sudo -E apt-get -yq --no-install-suggests --no-install-recommends --force-yes install llvm-4.0 llvm-4.0-dev g++-6 texinfo texi2html
    - pip install -r requirements.txt
before_script:
# install llvmlite
- git clone https://github.com/numba/llvmlite -b v0.17.1 && pushd llvmlite
- pip install -r requirements.txt && python setup.py build && pip install . && popd
# install tcc
- git clone http://repo.or.cz/tinycc.git -b release_0_9_26 && pushd tinycc
- ./configure --disable-static --tccdir=./ --libdir=$(pwd) --includedir=$(pwd)
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then make && ln -s libtcc.so.1.0 libtcc.so && export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd); fi && popd
# install miasm
- python setup.py build build_ext -I$(pwd)/tinycc -L$(pwd)/tinycc
- python setup.py install
script: cd test && python test_all.py
