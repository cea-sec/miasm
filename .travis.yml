sudo: false
dist: trusty
language: python
python:
- "2.7"
addons:
    apt:
        sources: ['llvm-toolchain-trusty-7', 'ubuntu-toolchain-r-test']
        packages:
            - make
            - gcc
            - python-virtualenv
            - unzip
            - llvm-7
            - llvm-7-dev
            - g++-7
before_script:
# codespell
- "pip install codespell && git ls-files | xargs codespell --ignore-words=.codespell_ignore 2>/dev/null"
- "cd .."
- "export LLVM_CONFIG=$(which llvm-config-7)"
- "export CXX=$(which g++-7)"
# make virtual env
- "python /usr/lib/python2.7/dist-packages/virtualenv.py virtualenv;"
- "cd virtualenv;"
- "source bin/activate;"
# install llvmlite
- "pip install enum34"
- 'CXX="$(which g++-7) -fPIC" pip install llvmlite'
# install elfesteem
- "git clone https://github.com/serpilliere/elfesteem elfesteem && cd elfesteem && python setup.py install && cd ..;"
# install pyparsing
- "pip install pyparsing"
# install pycparser
- "pip install pycparser"
# install z3 with a known to working version
- "wget https://github.com/serpilliere/z3-prebuild/raw/master/z3.tgz"
- "tar xzf z3.tgz"
- "cd z3/build"
- "make install"
- "cd ../.."
# Miasm
- "cd ..;"
- "cd miasm;"
# turn deprecation warning into RuntimeError
- "find . -name '*.py' | xargs sed -i 's/warnings\\.warn(/raise RuntimeError(/g'"
# install
- "python setup.py build build_ext -I$(pwd)/../virtualenv/include -L$(pwd)/../virtualenv/tinycc"
- "python setup.py install"
script: "python -c 'import z3; x = z3.BitVec(chr(0x41), 32)' && cd test && python test_all.py && git ls-files -o --exclude-standard"
